# ðŸ“˜ HomeVerse Production Deployment Runbook

**Version**: 1.0  
**Last Updated**: June 8, 2025  
**Status**: Active

## ðŸŽ¯ Overview

This runbook provides step-by-step instructions for deploying, maintaining, and troubleshooting HomeVerse in production environments.

## ðŸ“‹ Table of Contents

1. [Pre-Deployment Checklist](#pre-deployment-checklist)
2. [Deployment Steps](#deployment-steps)
3. [Post-Deployment Verification](#post-deployment-verification)
4. [Rollback Procedures](#rollback-procedures)
5. [Monitoring & Alerts](#monitoring--alerts)
6. [Incident Response](#incident-response)
7. [Maintenance Procedures](#maintenance-procedures)

---

## 1. Pre-Deployment Checklist

### Environment Verification
- [ ] Verify Render API key is set: `rnd_KqwZ5fjRivybWcsC9PqsHel2BDt8`
- [ ] Confirm database backups are current
- [ ] Check current deployment status
- [ ] Review pending changes in git
- [ ] Verify test suite passes locally

### Required Environment Variables
```bash
# Backend (homeverse-api)
DATABASE_URL=<auto-set-by-render>
JWT_SECRET_KEY=<auto-generated>
SENDGRID_API_KEY=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
CORS_ORIGINS=https://homeverse-frontend.onrender.com,http://localhost:3000
COMPANY_KEY=default-company-key
PORT=8000
LOG_LEVEL=INFO

# Frontend (homeverse-frontend)
NEXT_PUBLIC_API_URL=https://homeverse-api.onrender.com
NEXT_PUBLIC_MAPBOX_TOKEN=<your-mapbox-token>
PORT=3000
```

## 2. Deployment Steps

### A. Standard Deployment (Git Push)

```bash
# 1. Pull latest changes
git pull origin main

# 2. Run local tests
python -m pytest
cd frontend && npm test

# 3. Commit changes
git add .
git commit -m "ðŸš€ Deploy: <description>"

# 4. Push to trigger deployment
git push origin main

# 5. Monitor deployment
python monitor_deployment.py
```

### B. Manual Deployment (Render CLI)

```bash
# Set API key
export RENDER_API_KEY="rnd_KqwZ5fjRivybWcsC9PqsHel2BDt8"

# Deploy backend
curl -X POST \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Accept: application/json" \
  https://api.render.com/v1/services/srv-d11f4godl3ps73cnfr6g/deploys

# Deploy frontend
curl -X POST \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Accept: application/json" \
  https://api.render.com/v1/services/srv-d11f3q0dl3ps73cnf480/deploys
```

### C. Emergency Hotfix Deployment

```bash
# 1. Create hotfix branch
git checkout -b hotfix/critical-fix

# 2. Apply fix
# ... make changes ...

# 3. Test locally
python simple_backend.py  # Terminal 1
cd frontend && npm run dev  # Terminal 2

# 4. Deploy hotfix
git add .
git commit -m "ðŸš¨ Hotfix: <description>"
git push origin hotfix/critical-fix

# 5. Merge to main after verification
git checkout main
git merge hotfix/critical-fix
git push origin main
```

## 3. Post-Deployment Verification

### Health Checks
```bash
# Backend health
curl https://homeverse-api.onrender.com/health

# Frontend health
curl https://homeverse-frontend.onrender.com

# API documentation
curl https://homeverse-api.onrender.com/docs
```

### Functional Tests
```bash
# Test authentication
curl -X POST https://homeverse-api.onrender.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -H "x-company-key: test-company" \
  -d '{"email": "developer@test.com", "password": "password123"}'

# Test email functionality
curl -X POST https://homeverse-api.onrender.com/api/v1/contact \
  -H "Content-Type: application/json" \
  -H "x-company-key: test-company" \
  -d '{"name": "Test", "email": "test@example.com", "subject": "Test", "message": "Test"}'
```

### Smoke Test Checklist
- [ ] Homepage loads
- [ ] Login works for all user types
- [ ] Dashboard routing correct
- [ ] API endpoints responsive
- [ ] Email delivery functional
- [ ] Database queries working

## 4. Rollback Procedures

### Automatic Rollback (Render)
```bash
# Get previous deploy ID
curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
  https://api.render.com/v1/services/srv-d11f4godl3ps73cnfr6g/deploys?limit=2

# Rollback to previous deploy
curl -X POST \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Content-Type: application/json" \
  https://api.render.com/v1/services/srv-d11f4godl3ps73cnfr6g/deploys/<previous-deploy-id>/rollback
```

### Git-Based Rollback
```bash
# Find last working commit
git log --oneline -10

# Revert to specific commit
git revert <commit-hash>
git push origin main
```

## 5. Monitoring & Alerts

### Real-Time Monitoring
```bash
# Start automated monitoring
python deployment_auto_fixer.py

# Check deployment status
python monitor_deployment.py
```

### Key Metrics to Monitor
- Response time < 200ms
- Error rate < 1%
- Memory usage < 80%
- CPU usage < 70%
- Database connections < 90%

### Alert Thresholds
| Metric | Warning | Critical | Action |
|--------|---------|----------|--------|
| Response Time | > 500ms | > 1000ms | Scale up instances |
| Error Rate | > 1% | > 5% | Check logs, rollback |
| Memory | > 80% | > 90% | Restart service |
| Failed Logins | > 10/min | > 50/min | Check for attacks |

## 6. Incident Response

### Severity Levels
- **P1 (Critical)**: Complete outage, data loss risk
- **P2 (High)**: Major feature broken, degraded performance
- **P3 (Medium)**: Minor feature issues
- **P4 (Low)**: Cosmetic issues

### Response Procedures

#### P1 - Complete Outage
1. **Acknowledge** (< 5 min)
   ```bash
   # Check service status
   curl -I https://homeverse-api.onrender.com/health
   ```

2. **Diagnose** (< 15 min)
   ```bash
   # Check deployment status
   python monitor_deployment.py
   
   # Check Render dashboard
   open https://dashboard.render.com
   ```

3. **Mitigate** (< 30 min)
   - Rollback if recent deployment
   - Restart services if hung
   - Scale up if resource issue

4. **Communicate**
   - Update status page
   - Notify customers
   - Internal escalation

#### P2 - Degraded Service
1. Check specific endpoints
2. Review recent changes
3. Apply targeted fixes
4. Monitor recovery

### Common Issues & Fixes

#### Backend Won't Start
```bash
# Check logs
curl -H "Authorization: Bearer $RENDER_API_KEY" \
  https://api.render.com/v1/services/srv-d11f4godl3ps73cnfr6g/logs

# Common fixes:
# 1. Logger initialization â†’ Already fixed
# 2. Missing module â†’ Add to requirements.txt
# 3. Port issue â†’ Ensure using $PORT
```

#### Frontend Build Fails
```bash
# Clear cache and rebuild
cd frontend
rm -rf node_modules package-lock.json
npm install
npm run build
```

#### Database Connection Issues
```bash
# Verify DATABASE_URL is set
# Check connection limit
# Restart service to reset connections
```

## 7. Maintenance Procedures

### Daily Tasks
- [ ] Check deployment status
- [ ] Review error logs
- [ ] Verify backups completed
- [ ] Check email delivery rates

### Weekly Tasks
- [ ] Review performance metrics
- [ ] Update dependencies (test first)
- [ ] Clean up old logs
- [ ] Security scan

### Monthly Tasks
- [ ] Full backup verification
- [ ] Load testing
- [ ] Security audit
- [ ] Update documentation

### Database Maintenance
```bash
# Backup database
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

# Vacuum and analyze
psql $DATABASE_URL -c "VACUUM ANALYZE;"

# Check table sizes
psql $DATABASE_URL -c "
  SELECT schemaname,tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
  FROM pg_tables
  ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;"
```

### Certificate Renewal
- Render handles SSL certificates automatically
- No manual intervention required

## ðŸ“ž Emergency Contacts

### Escalation Path
1. **On-Call Engineer**: Check deployment_auto_fixer.py alerts
2. **Team Lead**: If P1 incident > 30 min
3. **CTO**: If P1 incident > 1 hour

### External Support
- **Render Support**: https://render.com/support
- **SendGrid Support**: https://support.sendgrid.com
- **GitHub Status**: https://githubstatus.com

## ðŸ”§ Troubleshooting Scripts

### Quick Diagnostics
```bash
#!/bin/bash
# save as diagnose.sh

echo "=== HomeVerse Production Diagnostics ==="
echo "Time: $(date)"
echo ""

echo "1. Checking Backend Health..."
curl -s https://homeverse-api.onrender.com/health | jq .

echo -e "\n2. Checking Frontend..."
curl -s -o /dev/null -w "%{http_code}" https://homeverse-frontend.onrender.com

echo -e "\n3. Testing Authentication..."
curl -s -X POST https://homeverse-api.onrender.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -H "x-company-key: test-company" \
  -d '{"email": "test@test.com", "password": "test"}' \
  | jq .error

echo -e "\n4. Deployment Status..."
python monitor_deployment.py | head -20
```

## ðŸ“š Additional Resources

- [Render Documentation](https://render.com/docs)
- [FastAPI Best Practices](https://fastapi.tiangolo.com/deployment/)
- [Next.js Production](https://nextjs.org/docs/going-to-production)
- [PostgreSQL Tuning](https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server)

---

**Remember**: When in doubt, the `deployment_auto_fixer.py` will handle most common issues automatically!