# üöÄ Render Deployment Configuration for HomeVerse v2.0.0

**Target:** Production deployment with security fixes and UI/UX improvements  
**Auto-Deploy:** GitHub main branch ‚Üí Render services  
**Estimated Deploy Time:** 8-12 minutes

## üìÑ Updated render.yaml

```yaml
services:
  # Backend API Service
  - type: web
    name: homeverse-api
    runtime: python
    env: python
    buildCommand: "pip install --upgrade pip && pip install -r requirements_supabase.txt"
    startCommand: "python3 supabase_backend.py"
    region: oregon
    plan: starter
    healthCheckPath: "/health"
    envVars:
      # Core Supabase Configuration
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      
      # Security Configuration (NEW for v2.0.0)
      - key: ENVIRONMENT
        value: "production"
      - key: ENCRYPTION_KEY
        sync: false  # CRITICAL: Set in Render dashboard
      - key: ENCRYPTION_SALT
        sync: false  # CRITICAL: Set in Render dashboard
      - key: JWT_SECRET_KEY
        sync: false  # CRITICAL: Set in Render dashboard
      - key: REDIS_URL
        sync: false  # For rate limiting
      
      # CORS Configuration (Updated for security)
      - key: CORS_ORIGINS
        value: "https://homeverse-frontend.onrender.com,https://homeverse.com"
      
      # External Services
      - key: SENDGRID_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      
      # System Configuration
      - key: PYTHONPATH
        value: "."
      - key: LOG_LEVEL
        value: "info"

  # Frontend Service
  - type: web
    name: homeverse-frontend
    runtime: node
    env: node
    buildCommand: "cd frontend && npm ci && npm run build"
    startCommand: "cd frontend && npm start"
    region: oregon
    plan: starter
    healthCheckPath: "/"
    envVars:
      # Public Supabase Configuration
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      
      # Public API Configuration
      - key: NEXT_PUBLIC_API_URL
        value: "https://homeverse-api.onrender.com"
      
      # Public Services
      - key: NEXT_PUBLIC_MAPBOX_TOKEN
        sync: false
      
      # Environment
      - key: NODE_ENV
        value: "production"
      - key: NEXT_PUBLIC_ENVIRONMENT
        value: "production"

# Redis service for rate limiting
  - type: redis
    name: homeverse-redis
    region: oregon
    plan: starter
    maxmemoryPolicy: allkeys-lru

# No database needed - using Supabase!
```

## üîê Critical Environment Variables Setup

### Security Variables (Must Set in Render Dashboard)

#### 1. Encryption Keys
```bash
# Generate strong encryption key (256-bit)
ENCRYPTION_KEY=$(openssl rand -base64 32)
echo "Set in Render: ENCRYPTION_KEY = $ENCRYPTION_KEY"

# Generate encryption salt (256-bit)
ENCRYPTION_SALT=$(openssl rand -base64 32)
echo "Set in Render: ENCRYPTION_SALT = $ENCRYPTION_SALT"
```

#### 2. JWT Secret
```bash
# Generate JWT secret (512-bit)
JWT_SECRET_KEY=$(openssl rand -hex 64)
echo "Set in Render: JWT_SECRET_KEY = $JWT_SECRET_KEY"
```

#### 3. Redis Configuration
```bash
# Redis URL (auto-generated by Render Redis service)
# Format: redis://red-xxxxx:password@hostname:port
# Will be automatically set when Redis service is created
REDIS_URL="redis://homeverse-redis:6379"
```

### Supabase Configuration (Existing)
```bash
# From your Supabase project dashboard
SUPABASE_URL="https://vzxadsifonqklotzhdpl.supabase.co"
SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
SUPABASE_SERVICE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Public frontend variables
NEXT_PUBLIC_SUPABASE_URL="https://vzxadsifonqklotzhdpl.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

## üì¶ Build Configuration Updates

### Requirements File Validation
```python
# requirements_supabase.txt additions for v2.0.0
fastapi==0.104.1
uvicorn==0.24.0
supabase==2.0.1
python-multipart==0.0.6
python-dotenv==1.0.0
sendgrid==6.11.0
redis==5.0.1

# NEW: Security dependencies
slowapi==0.1.9          # Rate limiting
cryptography==41.0.7    # PII encryption
jwt==1.3.1              # JWT handling

# Existing dependencies
psycopg2-binary==2.9.7
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
bcrypt==4.0.1
aiofiles==23.2.1
unstructured==0.11.2
```

### Frontend Build Updates
```json
// frontend/package.json key changes
{
  "name": "homeverse-frontend",
  "version": "2.0.0",
  "dependencies": {
    "next": "14.2.30",  // UPDATED: Security fix
    // ... other dependencies unchanged
  },
  "scripts": {
    "build": "next build",
    "start": "next start -p $PORT",  // Render uses $PORT
    "lint": "next lint",
    "typecheck": "tsc --noEmit"
  }
}
```

## üîç Health Check Configuration

### Backend Health Endpoint
```python
# Ensure this endpoint exists in supabase_backend.py
@app.get("/health")
async def health_check():
    """Health check endpoint for Render monitoring"""
    try:
        # Test database connection
        result = supabase.table("users").select("count", count="exact").execute()
        db_healthy = True
    except Exception as e:
        db_healthy = False
        
    # Test Redis connection (rate limiting)
    try:
        import redis
        redis_client = redis.from_url(os.getenv("REDIS_URL"))
        redis_client.ping()
        redis_healthy = True
    except Exception as e:
        redis_healthy = False
    
    # Test encryption service
    try:
        from your_encryption_service import PIIEncryption
        encryption = PIIEncryption()
        test_encrypted = encryption.encrypt("test")
        test_decrypted = encryption.decrypt(test_encrypted)
        encryption_healthy = test_decrypted == "test"
    except Exception as e:
        encryption_healthy = False
    
    status = {
        "status": "healthy" if all([db_healthy, redis_healthy, encryption_healthy]) else "unhealthy",
        "timestamp": datetime.utcnow().isoformat(),
        "services": {
            "database": "healthy" if db_healthy else "unhealthy",
            "redis": "healthy" if redis_healthy else "unhealthy", 
            "encryption": "healthy" if encryption_healthy else "unhealthy"
        },
        "version": "2.0.0"
    }
    
    return status
```

### Frontend Health Check
```typescript
// frontend/src/app/health/route.ts
export async function GET() {
    const status = {
        status: "healthy",
        timestamp: new Date().toISOString(),
        version: "2.0.0",
        environment: process.env.NODE_ENV,
        api_url: process.env.NEXT_PUBLIC_API_URL
    };
    
    return Response.json(status);
}
```

## üìä Deployment Monitoring

### Build Process Monitoring
```bash
# Watch build logs in real-time
curl -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/services/$SERVICE_ID/builds"

# Check service status
curl -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/services/$SERVICE_ID"
```

### Automated Deploy Notifications
```yaml
# .github/workflows/notify-deployment.yml
name: Deployment Notification
on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "üöÄ HomeVerse v2.0.0 deployment started",
              attachments: [{
                color: "good",
                fields: [{
                  title: "Branch",
                  value: "${{ github.ref }}",
                  short: true
                }, {
                  title: "Commit",
                  value: "${{ github.sha }}",
                  short: true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

## üö® Auto-Deploy Safety Checks

### Pre-Deploy Validation
```bash
#!/bin/bash
# pre_deploy_check.sh

echo "üîç Running pre-deployment safety checks..."

# Check for secrets in code
if grep -r "eyJ" . --exclude-dir=.git --exclude-dir=node_modules; then
    echo "‚ùå Found potential JWT tokens in code"
    exit 1
fi

# Validate environment variables
required_vars=("ENCRYPTION_KEY" "ENCRYPTION_SALT" "JWT_SECRET_KEY" "REDIS_URL")
for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "‚ùå Missing required environment variable: $var"
        exit 1
    fi
done

# Test build
echo "üèóÔ∏è Testing backend build..."
python -m py_compile supabase_backend.py || exit 1

echo "üèóÔ∏è Testing frontend build..."
cd frontend && npm run build || exit 1

echo "‚úÖ All pre-deployment checks passed"
```

### Post-Deploy Validation
```python
# post_deploy_validation.py
import asyncio
import aiohttp
import json

async def validate_deployment():
    """Validate deployment after auto-deploy completes"""
    
    base_url = "https://homeverse-api.onrender.com"
    frontend_url = "https://homeverse-frontend.onrender.com"
    
    async with aiohttp.ClientSession() as session:
        # Check backend health
        async with session.get(f"{base_url}/health") as response:
            if response.status != 200:
                raise Exception(f"Backend health check failed: {response.status}")
            
            health_data = await response.json()
            if health_data["status"] != "healthy":
                raise Exception(f"Backend unhealthy: {health_data}")
        
        # Check frontend health
        async with session.get(f"{frontend_url}/health") as response:
            if response.status != 200:
                raise Exception(f"Frontend health check failed: {response.status}")
        
        # Test rate limiting
        for i in range(7):
            async with session.post(f"{base_url}/api/v1/auth/login", 
                                   json={"email": "test@test.com", "password": "wrong"}) as response:
                if i >= 5 and response.status != 429:
                    raise Exception("Rate limiting not working")
        
        # Test encryption
        test_data = {"full_name": "Test User", "email": "test@test.com"}
        async with session.post(f"{base_url}/api/v1/test-encryption", 
                               json=test_data) as response:
            if response.status != 200:
                raise Exception("Encryption endpoint failed")
    
    print("‚úÖ All post-deployment validations passed")

if __name__ == "__main__":
    asyncio.run(validate_deployment())
```

## ‚ö° Emergency Rollback via GitHub

### Immediate Rollback
```bash
#!/bin/bash
# emergency_rollback.sh

echo "üö® Initiating emergency rollback..."

# Get the previous commit before the merge
PREVIOUS_COMMIT=$(git log --oneline -n 2 | tail -1 | cut -d' ' -f1)

# Create revert commit
git revert HEAD --no-edit

# Push to main (triggers immediate redeploy)
git push origin main

echo "‚úÖ Rollback commit pushed. Render will auto-deploy previous version."
echo "‚è±Ô∏è Expected rollback time: 8-12 minutes"

# Notify team
curl -X POST $SLACK_WEBHOOK_URL \
  -H 'Content-type: application/json' \
  --data '{"text":"üö® Emergency rollback initiated for HomeVerse production"}'
```

### Selective Component Rollback
```bash
# Rollback only security features
git checkout HEAD~1 -- supabase_backend.py
git commit -m "rollback: revert security features for debugging"
git push origin main

# Rollback only UI changes
git checkout HEAD~1 -- frontend/src/components/
git commit -m "rollback: revert UI changes for debugging"
git push origin main
```

## üìä Deployment Success Metrics

### Automated Monitoring
```javascript
// deployment_monitor.js
const monitor = {
    async checkDeploymentHealth() {
        const endpoints = [
            'https://homeverse-api.onrender.com/health',
            'https://homeverse-frontend.onrender.com/health'
        ];
        
        for (const endpoint of endpoints) {
            const response = await fetch(endpoint);
            if (!response.ok) {
                await this.alertTeam(`‚ùå ${endpoint} is unhealthy`);
                return false;
            }
        }
        
        await this.alertTeam("‚úÖ Deployment health check passed");
        return true;
    },
    
    async validateSecurityFeatures() {
        // Test rate limiting
        const rateLimit = await this.testRateLimit();
        
        // Test encryption
        const encryption = await this.testEncryption();
        
        // Test CORS
        const cors = await this.testCORS();
        
        return { rateLimit, encryption, cors };
    }
};

// Run every 5 minutes for first hour after deployment
setInterval(() => monitor.checkDeploymentHealth(), 5 * 60 * 1000);
```

## üìã Environment Variables Checklist

### Backend (homeverse-api)
- [ ] `SUPABASE_URL` - Existing
- [ ] `SUPABASE_SERVICE_KEY` - Existing  
- [ ] `SUPABASE_ANON_KEY` - Existing
- [ ] `ENCRYPTION_KEY` - **NEW** (Generate 256-bit)
- [ ] `ENCRYPTION_SALT` - **NEW** (Generate 256-bit)
- [ ] `JWT_SECRET_KEY` - **NEW** (Generate 512-bit)
- [ ] `REDIS_URL` - **NEW** (From Redis service)
- [ ] `ENVIRONMENT` - **NEW** (Set to "production")
- [ ] `CORS_ORIGINS` - **UPDATED** (Production domains)
- [ ] `SENDGRID_API_KEY` - Existing
- [ ] `OPENAI_API_KEY` - Existing

### Frontend (homeverse-frontend)  
- [ ] `NEXT_PUBLIC_SUPABASE_URL` - Existing
- [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Existing
- [ ] `NEXT_PUBLIC_API_URL` - **UPDATED** (Render backend URL)
- [ ] `NEXT_PUBLIC_MAPBOX_TOKEN` - Existing
- [ ] `NODE_ENV` - Set to "production"
- [ ] `NEXT_PUBLIC_ENVIRONMENT` - **NEW** (Set to "production")

### Redis Service
- [ ] Redis service created with name `homeverse-redis`
- [ ] Redis URL automatically provided to backend
- [ ] Memory policy set to `allkeys-lru`

---

**Status**: Ready for production deployment via GitHub auto-deploy to Render ‚úÖ